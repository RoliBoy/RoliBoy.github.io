<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <link rel="shortcut icon" type="image/png" href="images/favicon.png" />
    <title>defcamp2020-qr-mania</title>
    <meta name="description" content="defcamp 2020 qr mania writeup" />
    <meta name="keywords" content="roliboy, serotonin_undefined, ctf writeups, ctf, defcamp2020, qr mania" />
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/dracula.min.css" />
</head>
<body>
    <header class="header" role="heading">
        <div class="header-text-box row">
            <div class="header-text">
                <h1 class="heading-primary">
                    QR mania
                </h1>
                <p>
                    DefCamp 2020
                </p>
            </div>
        </div>
    </header>
    <main role="main">
        <section class="description" id="description">
            <div class="row">
                <h2>Description</h2>
                <ul class="section-list">
                    <li>
                        <b>Category:</b> [network, misc, programming]
                    </li>
                    <li>
                        <b>Points:<b> 50 (dynamic)
                    </li>
                    <li>
                        <b>Solves:</b> 75
                    </li>
                    <li>
                        <b>Difficulty:</b> medium
                    </li>
                    <li>
                        <b>Description:</b>
                        <pre class="section-code"><code class="plaintext">We intercepted some weird requests. See if you can extract some useful information.

Flag format: CTF{sha256}

The challenge was proposed by BIT SENTINEL.</code></pre>
                    </li>
                    <li>
                        <b>Files:</b>
                        <ul class="section-sublist">
                            <li>
                                <a
                                    href="https://api.cyberedu.ro/v1/contest/dctf2020/challenge/e40d5bc0-3565-11eb-b8d6-afd86980505c/download/457">
                                    challenge.pcap
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </section>
        <section class="writeup" id="writeup">
            <div class="row">
                <h2>Writeup</h2>
                <div class="section-box">
                    <div class="section-text">
                        <h3>
                            extracting http objects with wireshark
                        </h3>
                        <p>
                            inspecting the pcap file with wireshark reveals some http responses with png images
                        </p>
                        <p>
                            these can be extracted using the wireshark cli with the
                            <code>--export-objects</code>
                            option
                        </p>
                        <p>
                        <pre
                            class="section-code"><code>tshark -r challenge.pcap --export-objects "http,resources"</code></pre>
                        </p>
                        <p>
                            the extracted images contain colored qr codes, which decode to one character each
                        </p>
                        <p>
                            it is safe to assume that the flag has to be assembled from those characters; but what
                            about their order?
                        </p>
                    </div>
                </div>
                <div class="section-box">
                    <div class="section-text">
                        <h3>
                            extracting the order from the exif data
                        </h3>
                        <p>
                            turns out the position of each character is stored in the exif data of the corresponding
                            image
                        </p>
                        <pre class="section-code"><code>ls resources/*.png |\
xargs -n1 exiftool |\
grep -i 'file name\|comment' |\
awk '{print $NF}' |\
tr '\n' ' ' |\
sed 's/\/69/\n/g' |\
sed '/^ $/d' |\
sort -nk2 |\
awk '{print "resources/"$1}' >\
order.txt</code></pre>
                        <p>
                            <code>order.txt</code> now contains a list of filenames in the order in which the images
                            should be decoded
                        </p>
                    </div>
                </div>
                <div class="section-box">
                    <div class="section-text">
                        <h3>decoding the qr codes</h3>
                        <p>
                            using a python script, iterate over the filenames in the previously obtained order and
                            convert the qr codes to monochrome so they can be decoded with <code>pyzbar</code>:
                        </p>
                        <pre class="section-code"><code class="python">#!/usr/bin/env python
from pyzbar.pyzbar import decode

from PIL import Image

with open("order.txt") as order:
    for file in order:
        original_image = Image.open(file.strip())
        original_pixels = original_image.load()

        monochrome_image = Image.new(original_image.mode, original_image.size)
        monochrome_pixels = monochrome_image.load()

        background = original_pixels[0, 0]

        for i in range(original_image.size[0]):
            for j in range(original_image.size[1]):
                if original_pixels[i, j] == background:
                    monochrome_pixels[i, j] = (255, 255, 255, 255)
                else:
                    monochrome_pixels[i, j] = (0, 0, 0, 255)
        print(decode(monochrome_image)[0].data.decode('utf-8'), end='')
    print()</code></pre>
                    </div>
                </div>
                <div class="section-box">
                    <div class="section-text">
                        <h3>obtaining the flag</h3>
                        <p>
                            running the python script generates the following output:
                        </p>
                        <pre
                            class="section-code"><code>CTF{2b2e8580cdf35896d75bfc4b1bafff6ee90f6c525da3b9a26dd7726bf2171396}</code></pre>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer role="contentinfo" class="footer">
        <div class="row">
            <p style="text-align:left;">
                &copy; 2021 roliboy
            </p>
        </div>
    </footer>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script> -->
    <script>
        slideStates = [...document.getElementsByClassName('project-images')].reduce((o, k) => ({...o, [k.id]: 0}), {});
[...document.getElementsByClassName('project-images')].forEach(div => div.children[0].style.display = 'block');

function slidePrev(slideGroupName) {
  slideStates[slideGroupName]--
  let slides = [...document.getElementById(slideGroupName).children].filter(e => e.classList.contains("project-image"))
  if (slideStates[slideGroupName] < 0)
    slideStates[slideGroupName] = slides.length - 1
  for (let slide of slides)
    slide.style.display = 'none'
  slides[slideStates[slideGroupName]].style.display = 'block'
}

function slideNext(slideGroupName) {
  slideStates[slideGroupName]++
  let slides = [...document.getElementById(slideGroupName).children].filter(e => e.classList.contains("project-image"))
  if (slideStates[slideGroupName] >= slides.length)
    slideStates[slideGroupName] = 0
  for (let slide of slides)
    slide.style.display = 'none'
  slides[slideStates[slideGroupName]].style.display = 'block'
}

    </script>
</body>
</html>